<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>å–®å­—æ¸¬é©—å…¥å£</title>
  <link rel="stylesheet" href="./style.css" />
</head>

<body>
  <div class="wrap">
    <header class="topbarSimple">
      <div class="brand">
        <div class="logo" aria-hidden="true">Aa</div>
        <div class="brandText">
          <div class="brandTitle">å–®å­—æ¸¬é©—</div>
          <div class="brandSub">å…ˆé¸æ¢ä»¶ â†’ ç«‹åˆ»é–‹å§‹æ¸¬é©—</div>
        </div>
      </div>
    </header>

    <main class="card">
      <h2 class="h2">æ¸¬é©—å€</h2>

      <div class="formGrid">
        <label class="field">
          <div class="fieldLabel">é¸æ“‡å°å­©</div>
          <select id="kid">
            <option value="xigua">è¥¿ç“œ</option>
            <option value="youzi">æŸšå­</option>
            <option value="xiaole">å°æ¨‚</option>
            <option value="apu">é˜¿å™—</option>
            <option value="anan">å®‰å®‰</option>
          </select>
        </label>

        <label class="field">
          <div class="fieldLabel">é¸æ“‡é¡Œç›®åˆ†é¡</div>
          <select id="pool">
            <option value="all">å–®å­—åˆ†é¡ï¼ˆå…¨éƒ¨ï¼‰</option>
            <option value="new">æ–°åŠ å…¥ï¼ˆæ–°å­¸ï¼‰</option>
            <option value="wrong">éŒ¯é¡Œæœ¬</option>
          </select>
        </label>

        <label class="field">
          <div class="fieldLabel">ä¸é‡è¤‡å‰å¹¾å¤©æ¸¬é©—</div>
          <select id="avoidDays">
            <option value="0">ä¸é¿é–‹</option>
            <option value="1">1 å¤©</option>
            <option value="3" selected>3 å¤©</option>
            <option value="5">5 å¤©</option>
            <option value="7">7 å¤©</option>
          </select>
        </label>

        <label class="field">
          <div class="fieldLabel">é¸æ“‡æ¸¬é©—é¡Œç›®æ•¸é‡</div>
          <select id="numQ">
            <option value="10">10</option>
            <option value="15">15</option>
            <option value="20" selected>20</option>
            <option value="30">30</option>
            <option value="50">50</option>
          </select>
        </label>

        <label class="field">
          <div class="fieldLabel">æ¸¬é©—æ–¹å¼</div>
          <select id="mode">
            <option value="mc" selected>é¸æ“‡é¡Œ</option>
            <option value="type">Key in</option>
          </select>
        </label>

        <label class="field">
          <div class="fieldLabel">å–®å­—åˆ†é¡ï¼ˆå¯é¸ï¼‰</div>
          <select id="cat">
            <option value="">å…¨éƒ¨åˆ†é¡</option>
          </select>
        </label>
      </div>

      <div class="btnBar">
        <button id="btnGo" class="btn primary btnBig">é–‹å§‹æ¸¬é©—</button>
        <a class="btn ghost btnBig" href="./index.html">ç›´æ¥é€²æ¸¬é©—ï¼ˆç”¨ä¸Šæ¬¡è¨­å®šï¼‰</a>
      </div>

      <hr class="hr"/>

      <h2 class="h2">å·¥å…·å€</h2>
      <div class="toolLinks">
        <a class="linkBtn" href="./admin.html" target="_blank" rel="noopener">ğŸ”§ å¾Œå°å–®å­—</a>
        <a class="linkBtn" href="./tool.html" target="_blank" rel="noopener">ğŸ“¥ ç”¢å‡º words.json å·¥å…·</a>
      </div>

      <div class="hint">
        å»ºè­°æŠŠé€™é è¨­æˆå…¥å£ï¼šä½ çš„ç¶²å€ç”¨ <code>/home.html</code> é–‹å§‹ï¼Œé¸å¥½å°±é€²æ¸¬é©—ã€‚
      </div>
    </main>

    <footer class="bottomLinks">
      <a class="linkBtn" href="./home.html">ğŸ  å…¥å£</a>
      <a class="linkBtn" href="./index.html">ğŸ§© æ¸¬é©—</a>
    </footer>
  </div>

<script>
  // å…¥å£é åªåšï¼šè®€ words.json â†’ ç”¢ç”Ÿåˆ†é¡ä¸‹æ‹‰ â†’ å­˜è¨­å®šåˆ° localStorage
  const SETTINGS_KEY = "vocab_settings_v2";
  const CAT_OVERRIDE_KEY = "vocab_cat_override_v1";

  const $ = (id) => document.getElementById(id);
  const norm = (s) => String(s || "").trim();

  function todayKey(){
    const d = new Date();
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,"0");
    const day = String(d.getDate()).padStart(2,"0");
    return `${y}-${m}-${day}`;
  }

  function loadCatOverride(){
    try { return JSON.parse(localStorage.getItem(CAT_OVERRIDE_KEY) || "{}"); }
    catch { return {}; }
  }

  function effectiveCatOf(w, ov){
    const c = norm(ov[w.id] ?? w.cat ?? "");
    return c;
  }

  async function loadCats(){
    try{
      const res = await fetch("./words.json", { cache:"no-store" });
      const words = await res.json();
      const ov = loadCatOverride();

      const set = new Set();
      for (const w of (words||[])){
        if (!w || !w.id) continue;
        const c = effectiveCatOf(w, ov);
        if (c) set.add(c);
      }
      const cats = Array.from(set).sort((a,b)=>a.localeCompare(b, "zh-Hant"));

      $("cat").innerHTML = `<option value="">å…¨éƒ¨åˆ†é¡</option>` + cats.map(c => `<option value="${c}">${c}</option>`).join("");

    }catch(e){
      // æ²’åˆ†é¡ä¹Ÿæ²’é—œä¿‚
      $("cat").innerHTML = `<option value="">å…¨éƒ¨åˆ†é¡</option>`;
    }
  }

  function loadSettings(){
    try{
      const s = JSON.parse(localStorage.getItem(SETTINGS_KEY) || "{}");
      if (s.kid) $("kid").value = s.kid;
      if (s.pool) $("pool").value = s.pool;
      if (typeof s.avoidDays !== "undefined") $("avoidDays").value = String(s.avoidDays);
      if (s.numQ) $("numQ").value = String(s.numQ);
      if (s.mode) $("mode").value = s.mode;
      if (typeof s.cat !== "undefined") $("cat").value = s.cat || "";
    }catch{}
  }

  function saveAndGo(){
    const s = {
      kid: $("kid").value,
      pool: $("pool").value, // all/new/wrong
      avoidDays: Number($("avoidDays").value),
      numQ: Number($("numQ").value),
      mode: $("mode").value, // mc/type
      cat: $("cat").value || "",
      savedAt: todayKey()
    };
    localStorage.setItem(SETTINGS_KEY, JSON.stringify(s));
    // é€²å…¥æ¸¬é©—
    location.href = "./index.html";
  }

  $("btnGo").addEventListener("click", saveAndGo);

  loadCats().then(loadSettings);
</script>
</body>
</html>
