<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>單字後台（新學標註 / 分類編輯）</title>
  <style>
    :root{
      --bg:#f6f7fb;--card:#fff;--text:#111827;--muted:#6b7280;--bd:#e5e7eb;
      --dark:#111827;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans TC",sans-serif;background:var(--bg);color:var(--text)}
    .wrap{max-width:1120px;margin:18px auto;padding:0 14px}
    .card{background:var(--card);border:1px solid var(--bd);border-radius:18px;padding:14px}
    h1{margin:0 0 10px;font-size:18px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .pill{display:flex;gap:8px;align-items:center;font-weight:900;border:1px solid var(--bd);background:#fff;border-radius:999px;padding:8px 12px}
    input,select{border:1px solid var(--bd);border-radius:10px;padding:8px 10px;font-size:14px}
    .btn{border:1px solid var(--bd);background:#fff;border-radius:12px;padding:10px 12px;cursor:pointer;font-weight:900}
    .btn.primary{background:var(--dark);color:#fff;border-color:var(--dark)}
    .btn.danger{background:#fff;border-color:#fecaca;color:#991b1b}
    .muted{color:var(--muted);font-weight:700}
    .topnote{margin-top:8px;font-size:13px;color:var(--muted);font-weight:700;line-height:1.6}
    .count{font-weight:900;color:#111827}
    .grid{display:grid;grid-template-columns:repeat(1,1fr);gap:10px;margin-top:12px}
    @media(min-width:760px){.grid{grid-template-columns:repeat(2,1fr)}}
    @media(min-width:1040px){.grid{grid-template-columns:repeat(3,1fr)}}
    .item{border:1px solid var(--bd);border-radius:16px;padding:10px;display:flex;gap:10px;align-items:flex-start;background:#fff}
    .img{width:72px;height:72px;border-radius:12px;border:1px solid var(--bd);object-fit:cover;background:#f3f4f6}
    .meta{flex:1;min-width:0}
    .zh{font-size:16px;font-weight:900;margin:0}
    .en{margin:3px 0 0;font-weight:800;word-break:break-word}
    .tag{margin-top:6px;display:inline-block;font-size:12px;font-weight:900;color:#374151;background:#f3f4f6;border:1px solid var(--bd);padding:3px 8px;border-radius:999px}
    .idline{margin-top:6px;font-size:12px;color:var(--muted);font-weight:800;word-break:break-word}
    .actions{display:flex;flex-direction:column;gap:8px;align-items:stretch;min-width:110px}
    .star{border:1px solid var(--bd);border-radius:12px;padding:8px 10px;font-weight:900;background:#fff;cursor:pointer;white-space:nowrap}
    .star.on{background:var(--dark);color:#fff;border-color:var(--dark)}
    .catbox{display:flex;gap:8px;align-items:center;margin-top:8px}
    .catbox select{flex:1}
    .hint{font-size:12px;color:var(--muted);font-weight:700;margin-top:6px}
    .status{margin-top:8px;font-size:13px;font-weight:800}
    .ok{color:#065f46}
    .no{color:#9f1239}
    .divider{height:1px;background:var(--bd);margin:10px 0}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>單字後台（新學 ⭐ / 分類編輯）</h1>

      <div class="row">
        <div class="pill">
          使用者
          <select id="kidSelect">
            <option value="xigua">西瓜</option>
            <option value="youzi">柚子</option>
            <option value="xiaole">小樂</option>
            <option value="apu">阿噗</option>
            <option value="anan">安安</option>
          </select>
        </div>

        <div class="pill">
          篩選分類
          <select id="catFilter">
            <option value="">全部</option>
          </select>
        </div>

        <input id="q" placeholder="搜尋：中文 / 英文 / id / 分類" style="flex:1;min-width:240px;" />

        <button class="btn" id="btnClearNew" type="button">清空此小孩新學</button>
        <button class="btn" id="btnExportNew" type="button">匯出新學清單</button>
        <button class="btn" id="btnBatchCat" type="button">批次改分類</button>
        <button class="btn primary" id="btnExportWords" type="button">匯出新版 words.json</button>
        <button class="btn danger" id="btnClearCatOverride" type="button">清空分類覆寫</button>
      </div>

      <div class="topnote">
        使用者 <span id="kidName" class="count"></span> 的新學數：<span id="newCount" class="count">0</span>
        ｜目前顯示：<span id="shownCount" class="count">0</span> / <span id="totalCount" class="count">0</span>
        <br/>
        分類編輯會先存在此瀏覽器（localStorage）。要讓測驗頁永久吃到新分類：請按「匯出新版 words.json」→ 上傳覆蓋 repo 的 <span class="count">words.json</span>。
      </div>

      <div id="status" class="status"></div>
      <div class="divider"></div>

      <div class="row" style="margin-top:0;">
        <div class="pill">
          新增分類
          <input id="newCatName" placeholder="例如：水果" style="width:160px;" />
          <button class="btn" id="btnAddCat" type="button">加入</button>
        </div>
        <div class="hint">加入後會出現在「每筆分類下拉」與「篩選分類」中。</div>
      </div>

      <div id="grid" class="grid"></div>
    </div>
  </div>

<script>
  const WORDS_URL = "./words.json";
  const $ = (id) => document.getElementById(id);

  // ✅ 你指定的分類（順序就是顯示順序，可自行改）
  const FIXED_CATEGORIES = [
    "水果","動物","交通工具","食物","顏色","身體","家庭","學校用品","自然","運動","職業","其他"
  ];

  // ✅ 額外新增分類（你在後台加入的）
  function LS_EXTRA_CAT_KEY(){ return "vocab_extra_categories_v1"; }
  function loadExtraCats(){
    try { return JSON.parse(localStorage.getItem(LS_EXTRA_CAT_KEY()) || "[]"); }
    catch { return []; }
  }
  function saveExtraCats(arr){
    localStorage.setItem(LS_EXTRA_CAT_KEY(), JSON.stringify(arr));
  }

  // ✅ 新學清單（每個小孩各自）
  let kidId = localStorage.getItem("vocab_kid_active") || "xigua";
  function LS_NEW_KEY(){ return `vocab_new_v1_${kidId}`; }
  function loadNewSet(){
    try{
      const arr = JSON.parse(localStorage.getItem(LS_NEW_KEY()) || "[]");
      return new Set(Array.isArray(arr) ? arr : []);
    }catch{
      return new Set();
    }
  }
  function saveNewSet(set){
    localStorage.setItem(LS_NEW_KEY(), JSON.stringify(Array.from(set)));
  }

  // ✅ 分類覆寫（全站共用）：{ wordId: "新分類" }
  function LS_CAT_KEY(){ return "vocab_cat_override_v1"; }
  function loadCatOverride(){
    try { return JSON.parse(localStorage.getItem(LS_CAT_KEY()) || "{}"); }
    catch { return {}; }
  }
  function saveCatOverride(map){
    localStorage.setItem(LS_CAT_KEY(), JSON.stringify(map));
  }

  // 題庫
  let words = [];

  // ====== helpers ======
  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, m => ({
      "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"
    }[m]));
  }

  function showOk(msg){ $("status").innerHTML = `<span class="ok">✅ ${msg}</span>`; }
  function showNo(msg){ $("status").innerHTML = `<span class="no">⚠️ ${msg}</span>`; }
  function clearStatus(){ $("status").innerHTML = ""; }

  function effectiveCatOf(w, catOv){
    const c = (catOv[w.id] ?? w.cat ?? "");
    return String(c).trim();
  }

  function matches(w, q, effectiveCat){
    q = (q||"").trim().toLowerCase();
    if (!q) return true;
    return (
      String(w.id||"").toLowerCase().includes(q) ||
      String(w.zh||"").toLowerCase().includes(q) ||
      String(w.en||"").toLowerCase().includes(q) ||
      String(effectiveCat||"").toLowerCase().includes(q)
    );
  }

  function download(filename, text) {
    const blob = new Blob([text], { type: "application/json;charset=utf-8" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  // ====== categories ======
  function uniqCats(){
    const fromData = new Set();
    const catOv = loadCatOverride();

    for (const w of words) {
      const c = effectiveCatOf(w, catOv);
      if (c) fromData.add(c);
    }

    const extra = loadExtraCats().map(x => String(x).trim()).filter(Boolean);
    const fixed = FIXED_CATEGORIES.map(x => String(x).trim()).filter(Boolean);

    const fixedSet = new Set(fixed);
    const out = [];

    // 先放固定分類順序
    for (const c of fixed) out.push(c);

    // 再放你新增的分類（保持新增順序，但避免重複）
    for (const c of extra) {
      if (!fixedSet.has(c) && !out.includes(c)) out.push(c);
    }

    // 最後補上資料裡有但前兩者沒列到的（避免漏）
    const known = new Set(out);
    const extras = Array.from(fromData)
      .filter(c => !known.has(c))
      .sort((a,b)=>a.localeCompare(b, "zh-Hant"));

    return out.concat(extras);
  }

  function renderCatFilter(){
    const sel = $("catFilter");
    const keep = sel.value || "";
    sel.innerHTML = `<option value="">全部</option>`;
    for (const c of uniqCats()){
      const opt = document.createElement("option");
      opt.value = c;
      opt.textContent = c;
      sel.appendChild(opt);
    }
    if ([...sel.options].some(o => o.value === keep)) sel.value = keep;
  }

  // ====== main render ======
  function getFilteredList(){
    const q = $("q").value || "";
    const filterCat = $("catFilter").value || "";
    const catOv = loadCatOverride();

    const list = words.filter(w => {
      const ec = effectiveCatOf(w, catOv);
      if (filterCat && ec !== filterCat) return false;
      return matches(w, q, ec);
    });

    return list;
  }

  function render(){
    const grid = $("grid");
    const newSet = loadNewSet();
    const catOv = loadCatOverride();

    const filtered = getFilteredList();

    $("kidName").textContent = $("kidSelect").selectedOptions[0]?.textContent || kidId;
    $("newCount").textContent = newSet.size;
    $("shownCount").textContent = filtered.length;
    $("totalCount").textContent = words.length;

    renderCatFilter();

    grid.innerHTML = "";
    const cats = uniqCats(); // 用於每筆的分類下拉

    for (const w of filtered){
      const item = document.createElement("div");
      item.className = "item";

      const img = document.createElement("img");
      img.className = "img";
      img.src = w.img || "";
      img.alt = w.zh || "";
      img.onerror = () => { img.style.display="none"; };

      const meta = document.createElement("div");
      meta.className = "meta";

      const ec = effectiveCatOf(w, catOv);

      meta.innerHTML = `
        <p class="zh">${escapeHtml(w.zh || "")}</p>
        <div class="en">${escapeHtml(w.en || "")}</div>
        <span class="tag">${escapeHtml(ec || "未分類")}</span>
        <div class="idline">id: ${escapeHtml(w.id || "")}</div>
      `;

      // 分類編輯區（下拉 + 套用）
      const catBox = document.createElement("div");
      catBox.className = "catbox";

      const catSel = document.createElement("select");
      catSel.innerHTML = `<option value="">（未分類）</option>` + cats.map(c => `<option value="${escapeHtml(c)}">${escapeHtml(c)}</option>`).join("");
      catSel.value = ec;

      const btnSaveCat = document.createElement("button");
      btnSaveCat.type = "button";
      btnSaveCat.className = "btn";
      btnSaveCat.textContent = "套用";

      btnSaveCat.onclick = () => {
        const map = loadCatOverride();
        const v = String(catSel.value || "").trim();
        if (v) map[w.id] = v;
        else delete map[w.id];
        saveCatOverride(map);
        clearStatus();
        render();
      };

      catBox.appendChild(catSel);
      catBox.appendChild(btnSaveCat);
      meta.appendChild(catBox);

      const actions = document.createElement("div");
      actions.className = "actions";

      // ⭐ 新學
      const star = document.createElement("button");
      star.type = "button";
      const on = newSet.has(w.id);
      star.className = "star" + (on ? " on" : "");
      star.textContent = on ? "⭐ 已加入" : "⭐ 新學";

      star.onclick = () => {
        const s = loadNewSet();
        if (s.has(w.id)) s.delete(w.id);
        else s.add(w.id);
        saveNewSet(s);
        clearStatus();
        render();
      };

      actions.appendChild(star);

      item.appendChild(img);
      item.appendChild(meta);
      item.appendChild(actions);

      grid.appendChild(item);
    }

    if (!words.length) {
      showNo("目前 words.json 沒有資料");
    }
  }

  // ====== actions ======
  function handleAddCategory(){
    const v = String($("newCatName").value || "").trim();
    if (!v) return;

    const all = uniqCats();
    if (all.includes(v)) {
      showNo(`分類「${escapeHtml(v)}」已存在`);
      $("newCatName").value = "";
      return;
    }

    const extra = loadExtraCats();
    extra.push(v);
    saveExtraCats(extra);

    $("newCatName").value = "";
    showOk(`已加入分類：${escapeHtml(v)}`);
    render();
  }

  function handleBatchCat(){
    const filtered = getFilteredList();
    if (!filtered.length) {
      showNo("目前篩選結果是 0 筆，無法批次改分類");
      return;
    }

    const v = prompt("要把『目前篩選結果』全部改成哪個分類？\n例如：水果");
    if (v === null) return;
    const cat = String(v).trim();
    if (!cat) return;

    // 若新分類不存在，順便加入 extra（讓下拉馬上看得到）
    const cats = uniqCats();
    if (!cats.includes(cat)) {
      const extra = loadExtraCats();
      extra.push(cat);
      saveExtraCats(extra);
    }

    const map = loadCatOverride();
    for (const w of filtered) map[w.id] = cat;
    saveCatOverride(map);

    showOk(`已批次套用分類「${escapeHtml(cat)}」到 ${filtered.length} 筆`);
    render();
  }

  function handleExportNew(){
    const set = loadNewSet();
    const payload = {
      kidId,
      kidName: $("kidSelect").selectedOptions[0]?.textContent || kidId,
      exportedAt: new Date().toISOString(),
      newIds: Array.from(set)
    };
    download(`new-words-${kidId}.json`, JSON.stringify(payload, null, 2));
    showOk("已匯出新學清單");
  }

  function handleExportWords(){
    const map = loadCatOverride();

    // 合併分類覆寫 → 產出新版 words.json
    const merged = words.map(w => {
      const c = String((map[w.id] ?? w.cat ?? "")).trim();
      return { ...w, cat: c };
    });

    download("words.json", JSON.stringify(merged, null, 2));
    showOk("已下載新版 words.json（請回 repo 覆蓋上傳）");
  }

  function handleClearNew(){
    localStorage.removeItem(LS_NEW_KEY());
    showOk("已清空此小孩的新學");
    render();
  }

  function handleClearCatOverride(){
    const ok = confirm("確定要清空『分類覆寫』嗎？\n（會回到 words.json 原本的分類，但不會影響你已下載的檔案）");
    if (!ok) return;
    localStorage.removeItem(LS_CAT_KEY());
    showOk("已清空分類覆寫");
    render();
  }

  // ====== init ======
  async function init(){
    $("kidSelect").value = kidId;

    $("kidSelect").addEventListener("change", (e) => {
      kidId = e.target.value;
      localStorage.setItem("vocab_kid_active", kidId);
      clearStatus();
      render();
    });

    $("catFilter").addEventListener("change", () => { clearStatus(); render(); });
    $("q").addEventListener("input", () => { clearStatus(); render(); });

    $("btnAddCat").addEventListener("click", handleAddCategory);
    $("newCatName").addEventListener("keydown", (e) => {
      if (e.key === "Enter") handleAddCategory();
    });

    $("btnClearNew").addEventListener("click", handleClearNew);
    $("btnExportNew").addEventListener("click", handleExportNew);
    $("btnBatchCat").addEventListener("click", handleBatchCat);
    $("btnExportWords").addEventListener("click", handleExportWords);
    $("btnClearCatOverride").addEventListener("click", handleClearCatOverride);

    try{
      const res = await fetch(WORDS_URL, { cache: "no-store" });
      words = await res.json();

      // 基本清洗：至少要有 id/zh/en，img/cat 可空
      words = (words || []).filter(w => w && w.id && w.zh && w.en);

      clearStatus();
      renderCatFilter();
      render();
    }catch(err){
      console.error(err);
      showNo("載入失敗：請確認 words.json 在同一個 repo 根目錄，且是有效 JSON");
    }
  }

  init();
</script>
</body>
</html>
