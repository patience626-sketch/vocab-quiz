<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>å–®å­—å¾Œå°ï¼ˆè¦ªå­ç‰ˆï¼‰</title>

  <!-- è·Ÿæ¸¬é©—é å…±ç”¨åŒä¸€å¥—å¯æ„›é¢¨ -->
  <link rel="stylesheet" href="./style.css" />

  <style>
    /* admin å°ˆç”¨å°è£œä¸ï¼šç”¨ä½  style.css çš„è¦–è¦ºï¼Œä½†ç‰ˆé¢æ›´åƒå¾Œå° */
    .page{
      max-width: 1100px;
      margin: 0 auto;
      padding: 0 14px;
    }
    .adminTop{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
      padding: 14px 16px;
      margin-bottom: 14px;
    }
    .adminTitle{
      display:flex;align-items:center;gap:12px;
    }
    .adminBadge{
      width:44px;height:44px;border-radius:16px;
      display:flex;align-items:center;justify-content:center;
      font-weight:1100;
      background: linear-gradient(135deg, rgba(99,102,241,0.18), rgba(236,72,153,0.14));
      border: 1px solid rgba(99,102,241,0.20);
    }
    .adminH1{margin:0;font-size:18px;font-weight:1100;}
    .adminSub{margin-top:2px;color:var(--muted);font-weight:850;font-size:13px;line-height:1.5;}
    .toolbar{
      padding: 14px;
      margin-bottom: 14px;
    }
    .toolbarRow{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }
    .searchInput{
      flex: 1;
      min-width: 220px;
    }
    .hintBox{
      margin-top:10px;
      color: var(--muted);
      font-weight: 850;
      line-height: 1.6;
      font-size: 13px;
    }

    .statusBar{
      margin-top:10px;
      padding:10px 12px;
      border-radius:16px;
      border:1px solid rgba(15,23,42,0.08);
      background: rgba(255,255,255,0.7);
      font-weight: 1000;
      min-height: 24px;
    }
    .ok{color:#065f46;}
    .no{color:#9f1239;}

    .adminGrid{
      display:grid;
      grid-template-columns: 1fr;
      gap: 12px;
    }
    @media (min-width: 760px){
      .adminGrid{ grid-template-columns: 1fr 1fr; }
    }
    @media (min-width: 1040px){
      .adminGrid{ grid-template-columns: 1fr 1fr 1fr; }
    }

    .wordCard{
      padding: 12px;
      border-radius: 22px;
      border:1px solid rgba(15,23,42,0.08);
      background: rgba(255,255,255,0.80);
      box-shadow: 0 10px 25px rgba(15,23,42,0.05);
      display:flex;
      gap: 12px;
      align-items:flex-start;
    }
    .thumb{
      width: 74px;
      height: 74px;
      border-radius: 18px;
      border:1px solid rgba(15,23,42,0.10);
      background: #f1f5f9;
      object-fit: cover;
      flex:0 0 auto;
    }
    .wordMeta{ flex:1; min-width:0; }
    .zhBig{ font-size:18px; font-weight:1100; margin:0; line-height:1.2; }
    .enText{ margin-top:4px; font-weight:950; color:#0f172a; word-break:break-word; }
    .idText{ margin-top:6px; font-size:12px; color:var(--muted); font-weight:850; word-break:break-word; }
    .tagPill{
      display:inline-flex;
      align-items:center;
      gap:6px;
      margin-top:8px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(99,102,241,0.16);
      background: rgba(99,102,241,0.08);
      font-weight:1000;
      font-size:12px;
      color:#334155;
    }
    .rightCol{
      display:flex;
      flex-direction:column;
      gap:10px;
      align-items:stretch;
      min-width: 132px;
    }
    .miniBtn{
      border-radius: 16px;
      padding: 10px 12px;
      font-weight: 1100;
    }
    .miniBtn.on{
      background: linear-gradient(180deg, var(--primary), var(--primary2));
      color:#fff;
      border-color: rgba(0,0,0,0.15);
    }
    .catRow{
      display:flex;
      gap:8px;
      align-items:center;
      margin-top:10px;
    }
    .catRow select{ flex:1; }
    .countLine{
      margin-top:10px;
      color: var(--muted);
      font-weight: 900;
      font-size: 13px;
      line-height: 1.6;
    }
    .countLine .num{ font-weight:1100; color:#0f172a; }
    code{
      background: rgba(15,23,42,0.05);
      border: 1px solid rgba(15,23,42,0.08);
      padding: 2px 8px;
      border-radius: 999px;
      font-weight: 900;
    }
  </style>
</head>

<body>
  <div class="bg">
    <div class="page">

      <!-- top -->
      <header class="card adminTop">
        <div class="adminTitle">
          <div class="adminBadge">â­</div>
          <div>
            <h1 class="adminH1">å–®å­—å¾Œå°</h1>
            <div class="adminSub">æ¨™è¨»æ–°å­¸ã€èª¿æ•´åˆ†é¡ã€æ‰¹æ¬¡è™•ç†ã€åŒ¯å‡ºæ–°ç‰ˆ words.jsonï¼ˆè¦ªå­å¯æ„›ç‰ˆï¼‰</div>
          </div>
        </div>

        <div class="topActions">
          <a class="btn ghost" href="./index.html">ğŸ  å›æ¸¬é©—</a>
          <a class="btn ghost" href="./tool.html" target="_blank" rel="noopener">ğŸ“¥ åŒ¯å…¥å·¥å…·</a>
        </div>
      </header>

      <!-- toolbar -->
      <section class="card toolbar">
        <div class="toolbarRow">
          <label class="chip">
            ä½¿ç”¨è€…
            <select id="kidSelect">
              <option value="xigua">è¥¿ç“œ</option>
              <option value="youzi">æŸšå­</option>
              <option value="xiaole">å°æ¨‚</option>
              <option value="apu">é˜¿å™—</option>
              <option value="anan">å®‰å®‰</option>
            </select>
          </label>

          <label class="chip">
            ç¯©é¸åˆ†é¡
            <select id="catFilter">
              <option value="">å…¨éƒ¨</option>
            </select>
          </label>

          <input id="q" class="searchInput" placeholder="æœå°‹ï¼šä¸­æ–‡ / è‹±æ–‡ / id" />

          <button class="btn ghost" id="btnOnlyUncat" type="button">åªçœ‹æœªåˆ†é¡</button>
          <button class="btn ghost" id="btnOnlyNew" type="button">åªçœ‹æ–°å­¸</button>

          <button class="btn" id="btnBatchNew" type="button">æ‰¹æ¬¡åŠ å…¥æ–°å­¸</button>
          <button class="btn" id="btnClearNew" type="button">æ¸…ç©ºæ–°å­¸</button>
          <button class="btn ghost" id="btnExportNew" type="button">åŒ¯å‡ºæ–°å­¸</button>

          <button class="btn" id="btnBatchCat" type="button">æ‰¹æ¬¡æ”¹åˆ†é¡</button>
          <button class="btn primary" id="btnExportWords" type="button">åŒ¯å‡ºæ–°ç‰ˆ words.json</button>
          <button class="btn ghost" id="btnClearCatOverride" type="button">æ¸…ç©ºåˆ†é¡è¦†å¯«</button>

          <button class="btn" id="btnBackupAll" type="button">å‚™ä»½</button>
          <label class="btn ghost" for="fileRestore">é‚„åŸ
            <input id="fileRestore" type="file" accept=".json" style="display:none">
          </label>
        </div>

        <div class="countLine">
          ç›®å‰å°å­©ï¼š<span id="kidName" class="num"></span>ï½œ
          æ–°å­¸æ•¸ï¼š<span id="newCount" class="num">0</span>ï½œ
          é¡¯ç¤ºï¼š<span id="shownCount" class="num">0</span> / <span id="totalCount" class="num">0</span>
          <br/>
          <span class="hintBox">
            âœ… åˆ†é¡åªèƒ½ç”¨ä¸‹æ‹‰ï¼ˆé¿å…æ‰“éŒ¯å­—ï¼‰ã€‚è¦è®“æ¸¬é©—é æ°¸ä¹…åƒåˆ°åˆ†é¡ï¼šåŒ¯å‡ºæ–°ç‰ˆ <code>words.json</code> å¾Œå› repo è¦†è“‹ä¸Šå‚³ã€‚
          </span>
        </div>

        <div id="status" class="statusBar"></div>
      </section>

      <!-- grid -->
      <section id="grid" class="adminGrid"></section>

      <footer class="footer" style="margin-top:14px;">
        å¾Œå°ï¼ˆadmin.htmlï¼‰ï½œåŒ¯å…¥ï¼ˆtool.htmlï¼‰ï½œæ¸¬é©—ï¼ˆindex.htmlï¼‰
      </footer>
    </div>
  </div>

<script>
  const WORDS_URL = "./words.json";
  const $ = (id) => document.getElementById(id);

  const FIXED_CATEGORIES = ["æ°´æœ","å‹•ç‰©","äº¤é€šå·¥å…·","é£Ÿç‰©","é¡è‰²","èº«é«”","å®¶åº­","å­¸æ ¡ç”¨å“","è‡ªç„¶","é‹å‹•","è·æ¥­","å…¶ä»–"];
  const FIXED_SET = new Set(FIXED_CATEGORIES);

  function norm(s){ return String(s||"").trim(); }
  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, m => ({
      "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"
    }[m]));
  }

  function showOk(msg){ $("status").innerHTML = `<span class="ok">âœ… ${msg}</span>`; }
  function showNo(msg){ $("status").innerHTML = `<span class="no">âš ï¸ ${msg}</span>`; }
  function clearStatus(){ $("status").innerHTML = ""; }

  // kids
  let kidId = localStorage.getItem("vocab_kid_active") || "xigua";
  function LS_NEW_KEY(){ return `vocab_new_v1_${kidId}`; }

  function loadIdSet(key){
    try{
      const arr = JSON.parse(localStorage.getItem(key) || "[]");
      return new Set(Array.isArray(arr) ? arr : []);
    }catch{ return new Set(); }
  }
  function saveIdSet(key,set){
    localStorage.setItem(key, JSON.stringify(Array.from(set)));
  }

  // category override (global)
  const LS_CAT_KEY = "vocab_cat_override_v1";
  function loadCatOverride(){
    try { return JSON.parse(localStorage.getItem(LS_CAT_KEY) || "{}"); }
    catch { return {}; }
  }
  function saveCatOverride(map){
    localStorage.setItem(LS_CAT_KEY, JSON.stringify(map));
  }
  function normalizeCat(raw){
    const c = norm(raw);
    return FIXED_SET.has(c) ? c : "";
  }
  function effectiveCatOf(w, catOv){
    return normalizeCat(catOv[w.id] ?? w.cat ?? "");
  }

  // toggle filters
  const LS_ADMIN_FILTERS = "vocab_admin_filters_v2";
  let onlyUncat=false, onlyNew=false;
  function loadAdminFilters(){
    try{
      const o = JSON.parse(localStorage.getItem(LS_ADMIN_FILTERS) || "{}");
      onlyUncat=!!o.onlyUncat; onlyNew=!!o.onlyNew;
    }catch{ onlyUncat=false; onlyNew=false; }
  }
  function saveAdminFilters(){
    localStorage.setItem(LS_ADMIN_FILTERS, JSON.stringify({onlyUncat, onlyNew}));
  }
  function updateToggleUI(){
    // ç”¨ ghost æŒ‰éˆ• + on æ¨£å¼
    $("btnOnlyUncat").classList.toggle("on", onlyUncat);
    $("btnOnlyNew").classList.toggle("on", onlyNew);
    $("btnOnlyUncat").classList.toggle("primary", onlyUncat);
    $("btnOnlyNew").classList.toggle("primary", onlyNew);
  }

  // words
  let words = [];

  function renderCatFilter(){
    const sel = $("catFilter");
    const keep = sel.value || "";
    sel.innerHTML = `<option value="">å…¨éƒ¨</option>` + FIXED_CATEGORIES.map(c => `<option value="${escapeHtml(c)}">${escapeHtml(c)}</option>`).join("");
    if ([...sel.options].some(o => o.value === keep)) sel.value = keep;
  }

  function matches(w, q){
    q = norm(q).toLowerCase();
    if (!q) return true;
    return String(w.id||"").toLowerCase().includes(q)
      || String(w.zh||"").toLowerCase().includes(q)
      || String(w.en||"").toLowerCase().includes(q);
  }

  function getFilteredList(){
    const q = $("q").value || "";
    const filterCat = $("catFilter").value || "";
    const catOv = loadCatOverride();
    const newSet = loadIdSet(LS_NEW_KEY());

    return words.filter(w => {
      const ec = effectiveCatOf(w, catOv);
      if (filterCat && ec !== filterCat) return false;
      if (onlyUncat && !!ec) return false;
      if (onlyNew && !newSet.has(w.id)) return false;
      return matches(w, q);
    });
  }

  function download(filename, text) {
    const blob = new Blob([text], { type: "application/json;charset=utf-8" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  function render(){
    const grid = $("grid");
    const newSet = loadIdSet(LS_NEW_KEY());
    const catOv = loadCatOverride();
    const filtered = getFilteredList();

    $("kidName").textContent = $("kidSelect").selectedOptions[0]?.textContent || kidId;
    $("newCount").textContent = newSet.size;
    $("shownCount").textContent = filtered.length;
    $("totalCount").textContent = words.length;

    renderCatFilter();
    updateToggleUI();

    grid.innerHTML = "";

    for (const w of filtered){
      const card = document.createElement("div");
      card.className = "wordCard";

      const img = document.createElement("img");
      img.className = "thumb";
      img.src = w.img || "";
      img.alt = w.zh || "";
      img.onerror = () => { img.style.display = "none"; };

      const meta = document.createElement("div");
      meta.className = "wordMeta";

      const ec = effectiveCatOf(w, catOv);

      meta.innerHTML = `
        <p class="zhBig">${escapeHtml(w.zh||"")}</p>
        <div class="enText">${escapeHtml(w.en||"")}</div>
        <div class="tagPill">ğŸ·ï¸ ${escapeHtml(ec || "æœªåˆ†é¡")}</div>
        <div class="idText">idï¼š${escapeHtml(w.id||"")}</div>
      `;

      const catRow = document.createElement("div");
      catRow.className = "catRow";

      const catSel = document.createElement("select");
      catSel.innerHTML =
        `<option value="">ï¼ˆæœªåˆ†é¡ï¼‰</option>` +
        FIXED_CATEGORIES.map(c => `<option value="${escapeHtml(c)}">${escapeHtml(c)}</option>`).join("");
      catSel.value = ec;

      const btnApply = document.createElement("button");
      btnApply.type = "button";
      btnApply.className = "btn";
      btnApply.textContent = "å¥—ç”¨åˆ†é¡";
      btnApply.onclick = () => {
        const map = loadCatOverride();
        const v = normalizeCat(catSel.value);
        if (v) map[w.id] = v;
        else delete map[w.id];
        saveCatOverride(map);
        clearStatus();
        render();
      };

      catRow.appendChild(catSel);
      catRow.appendChild(btnApply);
      meta.appendChild(catRow);

      const right = document.createElement("div");
      right.className = "rightCol";

      const star = document.createElement("button");
      star.type = "button";
      const on = newSet.has(w.id);
      star.className = "btn miniBtn" + (on ? " on" : "");
      star.textContent = on ? "â­ å·²åŠ å…¥" : "â­ æ–°å­¸";
      star.onclick = () => {
        const s = loadIdSet(LS_NEW_KEY());
        if (s.has(w.id)) s.delete(w.id);
        else s.add(w.id);
        saveIdSet(LS_NEW_KEY(), s);
        clearStatus();
        render();
      };

      right.appendChild(star);

      card.appendChild(img);
      card.appendChild(meta);
      card.appendChild(right);
      grid.appendChild(card);
    }
  }

  function handleBatchNew(){
    const filtered = getFilteredList();
    if (!filtered.length) return showNo("ç›®å‰ç¯©é¸çµæœ 0 ç­†ï¼Œç„¡æ³•æ‰¹æ¬¡åŠ å…¥æ–°å­¸");

    const s = loadIdSet(LS_NEW_KEY());
    let added = 0;
    for (const w of filtered){
      if (!s.has(w.id)){ s.add(w.id); added++; }
    }
    saveIdSet(LS_NEW_KEY(), s);
    showOk(`å·²æ‰¹æ¬¡åŠ å…¥æ–°å­¸ï¼šæ–°å¢ ${added} ç­†ï¼ˆç¯©é¸çµæœ ${filtered.length} ç­†ï¼‰`);
    render();
  }

  function handleBatchCat(){
    const filtered = getFilteredList();
    if (!filtered.length) return showNo("ç›®å‰ç¯©é¸çµæœ 0 ç­†ï¼Œç„¡æ³•æ‰¹æ¬¡æ”¹åˆ†é¡");

    const pick = prompt(
      "è¦æŠŠã€ç›®å‰ç¯©é¸çµæœã€å…¨éƒ¨æ”¹æˆå“ªå€‹åˆ†é¡ï¼Ÿ\nåªèƒ½è¼¸å…¥ä»¥ä¸‹å…¶ä¸­ä¸€å€‹ï¼š\n" + FIXED_CATEGORIES.join(" / ")
    );
    if (pick === null) return;

    const cat = normalizeCat(pick);
    if (!cat) return showNo("åˆ†é¡ä¸åœ¨å›ºå®šæ¸…å–®å…§ï¼Œè«‹ç…§æ¸…å–®è¼¸å…¥ï¼ˆé¿å…æ‰“éŒ¯å­—ï¼‰");

    const map = loadCatOverride();
    for (const w of filtered) map[w.id] = cat;
    saveCatOverride(map);
    showOk(`å·²æ‰¹æ¬¡å¥—ç”¨åˆ†é¡ã€Œ${escapeHtml(cat)}ã€åˆ° ${filtered.length} ç­†`);
    render();
  }

  function handleExportNew(){
    const set = loadIdSet(LS_NEW_KEY());
    const payload = {
      kidId,
      kidName: $("kidSelect").selectedOptions[0]?.textContent || kidId,
      exportedAt: new Date().toISOString(),
      newIds: Array.from(set)
    };
    download(`new-words-${kidId}.json`, JSON.stringify(payload, null, 2));
    showOk("å·²åŒ¯å‡ºæ–°å­¸æ¸…å–®");
  }

  function handleExportWords(){
    const catOv = loadCatOverride();
    const merged = words.map(w => {
      const cat = effectiveCatOf(w, catOv);
      return { ...w, cat };
    });
    download("words.json", JSON.stringify(merged, null, 2));
    showOk("å·²ä¸‹è¼‰æ–°ç‰ˆ words.jsonï¼ˆè«‹å› repo è¦†è“‹ä¸Šå‚³ï¼‰");
  }

  function handleClearNew(){
    localStorage.removeItem(LS_NEW_KEY());
    showOk("å·²æ¸…ç©ºæ­¤å°å­©æ–°å­¸");
    render();
  }

  function handleClearCatOverride(){
    const ok = confirm("ç¢ºå®šè¦æ¸…ç©ºã€åˆ†é¡è¦†å¯«ã€å—ï¼Ÿï¼ˆå›åˆ° words.json åŸæœ¬ catï¼‰");
    if (!ok) return;
    localStorage.removeItem(LS_CAT_KEY);
    showOk("å·²æ¸…ç©ºåˆ†é¡è¦†å¯«");
    render();
  }

  function toggleOnlyUncat(){ onlyUncat=!onlyUncat; saveAdminFilters(); clearStatus(); render(); }
  function toggleOnlyNew(){ onlyNew=!onlyNew; saveAdminFilters(); clearStatus(); render(); }

  function handleBackup(){
    const backup = { exportedAt: new Date().toISOString(), localStorage: {} };
    const keys = Object.keys(localStorage).filter(k =>
      k === "vocab_kid_active" ||
      k === "vocab_cat_override_v1" ||
      k.startsWith("vocab_new_v1_") ||
      k.startsWith("vocab_wrong_v1_") ||
      k.startsWith("vocab_seen_v1_")
    );
    for (const k of keys) backup.localStorage[k] = localStorage.getItem(k);
    download("vocab-backup.json", JSON.stringify(backup, null, 2));
    showOk("å·²ä¸‹è¼‰å‚™ä»½æª” vocab-backup.json");
  }

  async function handleRestore(e){
    const file = e.target.files?.[0];
    if (!file) return;
    try{
      const text = await file.text();
      const data = JSON.parse(text);
      const map = data?.localStorage || {};
      for (const [k,v] of Object.entries(map)){
        if (typeof v === "string") localStorage.setItem(k, v);
      }
      alert("é‚„åŸå®Œæˆï¼è«‹é‡æ–°æ•´ç† admin èˆ‡æ¸¬é©—é ã€‚");
    }catch{
      alert("é‚„åŸå¤±æ•—ï¼šæª”æ¡ˆä¸æ˜¯æ­£ç¢ºå‚™ä»½ JSON");
    }finally{
      e.target.value = "";
    }
  }

  async function init(){
    loadAdminFilters();
    $("kidSelect").value = kidId;

    $("kidSelect").addEventListener("change", (e) => {
      kidId = e.target.value;
      localStorage.setItem("vocab_kid_active", kidId);
      clearStatus();
      render();
    });

    $("catFilter").addEventListener("change", () => { clearStatus(); render(); });
    $("q").addEventListener("input", () => { clearStatus(); render(); });

    $("btnOnlyUncat").addEventListener("click", toggleOnlyUncat);
    $("btnOnlyNew").addEventListener("click", toggleOnlyNew);

    $("btnBatchNew").addEventListener("click", handleBatchNew);
    $("btnClearNew").addEventListener("click", handleClearNew);
    $("btnExportNew").addEventListener("click", handleExportNew);

    $("btnBatchCat").addEventListener("click", handleBatchCat);
    $("btnExportWords").addEventListener("click", handleExportWords);
    $("btnClearCatOverride").addEventListener("click", handleClearCatOverride);

    $("btnBackupAll").addEventListener("click", handleBackup);
    $("fileRestore").addEventListener("change", handleRestore);

    try{
      const res = await fetch(WORDS_URL, { cache: "no-store" });
      words = await res.json();
      words = (words || []).filter(w => w && w.id && w.zh && w.en).map(w => ({
        id: norm(w.id), zh: norm(w.zh), en: norm(w.en),
        img: norm(w.img||""), cat: normalizeCat(w.cat||"")
      }));
      clearStatus();
      renderCatFilter();
      render();
    }catch(err){
      console.error(err);
      showNo("è¼‰å…¥å¤±æ•—ï¼šè«‹ç¢ºèª words.json åœ¨ repo æ ¹ç›®éŒ„ä¸” JSON æ­£ç¢º");
    }
  }

  init();
</script>
</body>
</html>
