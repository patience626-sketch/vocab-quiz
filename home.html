<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>單字測驗入口</title>
  <link rel="stylesheet" href="./style.css" />
</head>

<body>
  <div class="wrap">
    <header class="topbarSimple">
      <div class="brand">
        <div class="logo" aria-hidden="true">Aa</div>
        <div class="brandText">
          <div class="brandTitle">單字測驗入口</div>
          <div class="brandSub">先選好條件，再開始測驗（大按鈕版）</div>
        </div>
      </div>
    </header>

    <main class="card entranceCard">
      <div class="entranceGrid">

        <!-- 左：測驗設定（大按鈕選單） -->
        <section class="entrancePanel">
          <div class="panelTitle">🧩 測驗區選擇</div>

          <div class="bigPickGrid">
            <button class="pickBtn" id="pickKid" type="button">
              <div class="pickTop">選擇小孩</div>
              <div class="pickVal" id="kidLabel">西瓜</div>
              <div class="pickHint">點我切換</div>
            </button>

            <button class="pickBtn" id="pickPool" type="button">
              <div class="pickTop">題目分類</div>
              <div class="pickVal" id="poolLabel">單字分類（全部）</div>
              <div class="pickHint">全部 / 新加入 / 錯題本</div>
            </button>

            <button class="pickBtn" id="pickAvoid" type="button">
              <div class="pickTop">避開近幾天重複</div>
              <div class="pickVal" id="avoidLabel">3 天</div>
              <div class="pickHint">0/1/3/5/7 天</div>
            </button>

            <button class="pickBtn" id="pickNum" type="button">
              <div class="pickTop">測驗題數</div>
              <div class="pickVal" id="numLabel">20 題</div>
              <div class="pickHint">10/15/20/30/50</div>
            </button>

            <button class="pickBtn" id="pickMode" type="button">
              <div class="pickTop">測驗方式</div>
              <div class="pickVal" id="modeLabel">選擇題</div>
              <div class="pickHint">選擇題 / Key in</div>
            </button>

            <button class="pickBtn" id="pickCat" type="button">
              <div class="pickTop">單字分類（可選）</div>
              <div class="pickVal" id="catLabel">全部分類</div>
              <div class="pickHint">點我選分類</div>
            </button>
          </div>

          <div class="entranceActions">
            <button id="btnGo" class="btn primary btnBig btnStartHuge" type="button">
              🚀 開始測驗
            </button>
            <a class="btn ghost btnBig btnStartHuge" href="./index.html">
              直接進測驗（用上次設定）
            </a>
          </div>

          <div class="hint">
            小提醒：你可以把入口當首頁使用：<code>/home.html</code>
          </div>
        </section>

        <!-- 右：工具區（大按鈕） -->
        <section class="entrancePanel toolPanel">
          <div class="panelTitle">🧰 工具區</div>

          <a class="toolCard" href="./admin.html" target="_blank" rel="noopener">
            <div class="toolEmoji">🔧</div>
            <div class="toolText">
              <div class="toolName">後台單字</div>
              <div class="toolDesc">標註新學 / 改分類 / 批次 / 匯出 words.json</div>
            </div>
          </a>

          <a class="toolCard" href="./tool.html" target="_blank" rel="noopener">
            <div class="toolEmoji">📥</div>
            <div class="toolText">
              <div class="toolName">產出 words.json 工具</div>
              <div class="toolDesc">貼 Excel 表格 → 一鍵轉 words.json</div>
            </div>
          </a>

          <div class="bottomLinks" style="margin-top:12px;">
            <a class="linkBtn" href="./home.html">🏠 入口</a>
            <a class="linkBtn" href="./index.html">🧩 測驗</a>
          </div>
        </section>

      </div>
    </main>
  </div>

<script>
  const SETTINGS_KEY = "vocab_settings_v2";
  const CAT_OVERRIDE_KEY = "vocab_cat_override_v1";
  const $ = (id) => document.getElementById(id);
  const norm = (s) => String(s||"").trim();

  // --- state ---
  const kids = [
    {v:"xigua", t:"西瓜"},
    {v:"youzi", t:"柚子"},
    {v:"xiaole", t:"小樂"},
    {v:"apu", t:"阿噗"},
    {v:"anan", t:"安安"},
  ];
  const pools = [
    {v:"all", t:"單字分類（全部）"},
    {v:"new", t:"新加入（新學）"},
    {v:"wrong", t:"錯題本"},
  ];
  const avoids = [0,1,3,5,7];
  const nums = [10,15,20,30,50];
  const modes = [
    {v:"mc", t:"選擇題"},
    {v:"type", t:"Key in"},
  ];

  let s = {
    kid:"xigua", pool:"all", avoidDays:3, numQ:20, mode:"mc", cat:""
  };

  function todayKey(){
    const d = new Date();
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,"0");
    const day = String(d.getDate()).padStart(2,"0");
    return `${y}-${m}-${day}`;
  }

  function loadSettings(){
    try{
      const v = JSON.parse(localStorage.getItem(SETTINGS_KEY) || "{}");
      s.kid = v.kid || s.kid;
      s.pool = v.pool || s.pool;
      s.avoidDays = typeof v.avoidDays === "number" ? v.avoidDays : s.avoidDays;
      s.numQ = typeof v.numQ === "number" ? v.numQ : s.numQ;
      s.mode = v.mode || s.mode;
      s.cat = v.cat || "";
    }catch{}
  }

  function saveSettings(){
    const out = {...s, savedAt: todayKey()};
    localStorage.setItem(SETTINGS_KEY, JSON.stringify(out));
  }

  function label(){
    $("kidLabel").textContent = kids.find(x=>x.v===s.kid)?.t || "西瓜";
    $("poolLabel").textContent = pools.find(x=>x.v===s.pool)?.t || "單字分類（全部）";
    $("avoidLabel").textContent = (s.avoidDays===0 ? "不避開" : `${s.avoidDays} 天`);
    $("numLabel").textContent = `${s.numQ} 題`;
    $("modeLabel").textContent = modes.find(x=>x.v===s.mode)?.t || "選擇題";
    $("catLabel").textContent = s.cat ? s.cat : "全部分類";
  }

  function cycle(list, current, key){
    const idx = list.findIndex(x => (typeof x==="object" ? x.v : x) === current);
    const next = list[(idx + 1 + list.length) % list.length];
    s[key] = (typeof next === "object") ? next.v : next;
    label();
  }

  // load categories from words.json (optional)
  async function loadCats(){
    try{
      const ov = JSON.parse(localStorage.getItem(CAT_OVERRIDE_KEY) || "{}");
      const res = await fetch("./words.json", {cache:"no-store"});
      const words = await res.json();
      const set = new Set();
      for (const w of (words||[])){
        if (!w || !w.id) continue;
        const c = norm(ov[w.id] ?? w.cat ?? "");
        if (c) set.add(c);
      }
      const cats = Array.from(set).sort((a,b)=>a.localeCompare(b,"zh-Hant"));
      return cats;
    }catch{
      return [];
    }
  }

  function pickFromPrompt(title, options, current){
    const lines = options.map((o,i)=>`${i+1}. ${o}`).join("\n");
    const curIdx = Math.max(0, options.indexOf(current)) + 1;
    const ans = prompt(`${title}\n\n${lines}\n\n目前：${curIdx}\n輸入數字：`);
    if (ans === null) return current;
    const n = Number(ans);
    if (!Number.isFinite(n) || n<1 || n>options.length) return current;
    return options[n-1];
  }

  // click bindings
  $("pickKid").addEventListener("click", () => cycle(kids, s.kid, "kid"));
  $("pickPool").addEventListener("click", () => cycle(pools, s.pool, "pool"));
  $("pickAvoid").addEventListener("click", () => cycle(avoids, s.avoidDays, "avoidDays"));
  $("pickNum").addEventListener("click", () => cycle(nums, s.numQ, "numQ"));
  $("pickMode").addEventListener("click", () => cycle(modes, s.mode, "mode"));

  $("pickCat").addEventListener("click", async () => {
    const cats = await loadCats();
    if (!cats.length){
      alert("目前 words.json 沒有分類或讀取不到分類（仍可用全部分類測驗）。");
      return;
    }
    const options = ["全部分類", ...cats];
    const chosen = pickFromPrompt("選擇分類", options, s.cat ? s.cat : "全部分類");
    s.cat = (chosen === "全部分類") ? "" : chosen;
    label();
  });

  $("btnGo").addEventListener("click", () => {
    saveSettings();
    // 直接進測驗
    location.href = "./index.html";
  });

  // init
  loadSettings();
  label();
</script>
</body>
</html>
