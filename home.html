<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>單字測驗入口</title>
  <link rel="stylesheet" href="./style.css" />
</head>

<body class="homePage">
  <div class="homeShell">
    <div class="homeFrame">
      <header class="homeHeader">
        <div class="homeTitleRow">
          <div class="homeTitle">單字測驗</div>
          <div class="homeSub">入口選擇（選好再開始）</div>
        </div>
      </header>

      <main class="homeCard">
        <div class="homeHowto">
          <div class="homeHowtoTitle">🧸 怎麼玩？</div>
          <ul class="homeHowtoList">
            <li>先選小孩、題庫、題數、模式</li>
            <li>進入測驗頁：看圖＋中文 → 點🔊聽發音 → 作答</li>
            <li>答錯會進錯題本，之後可專練</li>
          </ul>
        </div>

        <section class="homeSection">
          <div class="homeSectionTitle">🧩 測驗區選擇</div>

          <div class="homeForm">
            <label class="homeField">
              <div class="homeLabel">選擇小孩</div>
              <div class="homeSelect">
                <span class="homeIcon">👧</span>
                <select id="kid">
                  <option value="xigua">西瓜</option>
                  <option value="youzi">柚子</option>
                  <option value="xiaole">小樂</option>
                  <option value="apu">阿噗</option>
                  <option value="anan">安安</option>
                </select>
              </div>
            </label>

            <label class="homeField">
              <div class="homeLabel">題目分類</div>
              <div class="homeSelect">
                <span class="homeIcon">🗂️</span>
                <select id="pool">
                  <option value="all" selected>單字分類（全部）</option>
                  <option value="new">新加入（新學）</option>
                  <option value="wrong">錯題本</option>
                </select>
              </div>
            </label>

            <label class="homeField">
              <div class="homeLabel">單字分類（可選）</div>
              <div class="homeSelect">
                <span class="homeIcon">🏷️</span>
                <select id="cat">
                  <option value="">全部分類</option>
                </select>
              </div>
            </label>

            <label class="homeField">
              <div class="homeLabel">避開近幾天重複</div>
              <div class="homeSelect">
                <span class="homeIcon">🧠</span>
                <select id="avoidDays">
                  <option value="0">不避開</option>
                  <option value="1">1 天</option>
                  <option value="3" selected>3 天</option>
                  <option value="5">5 天</option>
                  <option value="7">7 天</option>
                </select>
              </div>
            </label>

            <label class="homeField">
              <div class="homeLabel">題目數量</div>
              <div class="homeSelect">
                <span class="homeIcon">🎯</span>
                <select id="numQ">
                  <option value="10">10</option>
                  <option value="15">15</option>
                  <option value="20" selected>20</option>
                  <option value="30">30</option>
                  <option value="50">50</option>
                </select>
              </div>
            </label>

            <label class="homeField">
              <div class="homeLabel">測驗方式</div>
              <div class="homeSelect">
                <span class="homeIcon">⌨️</span>
                <select id="mode">
                  <option value="mc" selected>選擇題</option>
                  <option value="type">Key in</option>
                </select>
              </div>
            </label>
          </div>

          <div class="homeActions">
            <button id="btnGo" class="homeGo">開始測驗 GO!</button>
            <a class="homeGhost" href="./index.html">直接進測驗（用上次設定）</a>
          </div>
        </section>

        <section class="homeSection">
          <div class="homeSectionTitle">🧰 工具區連結</div>
          <div class="homeTools">
            <a class="homeToolBtn" href="./admin.html" target="_blank" rel="noopener">🔧 後台單字</a>
            <a class="homeToolBtn" href="./tool.html" target="_blank" rel="noopener">📥 產出 words.json 工具</a>
          </div>
        </section>

        <footer class="homeFooter">
          <a class="homeFooterLink" href="./home.html">🏠 入口</a>
          <a class="homeFooterLink" href="./index.html">🧩 測驗</a>
        </footer>
      </main>
    </div>
  </div>

<script>
  const SETTINGS_KEY = "vocab_settings_v2";
  const CAT_OVERRIDE_KEY = "vocab_cat_override_v1";
  const $ = (id) => document.getElementById(id);
  const norm = (s) => String(s || "").trim();

  function todayKey(){
    const d = new Date();
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,"0");
    const day = String(d.getDate()).padStart(2,"0");
    return `${y}-${m}-${day}`;
  }

  function loadSettings(){
    try{
      const s = JSON.parse(localStorage.getItem(SETTINGS_KEY) || "{}");
      if (s.kid) $("kid").value = s.kid;
      if (s.pool) $("pool").value = s.pool;
      if (typeof s.avoidDays !== "undefined") $("avoidDays").value = String(s.avoidDays);
      if (s.numQ) $("numQ").value = String(s.numQ);
      if (s.mode) $("mode").value = s.mode;
      if (typeof s.cat !== "undefined") $("cat").value = s.cat || "";
    }catch{}
  }

  function saveSettings(){
    const s = {
      kid: $("kid").value,
      pool: $("pool").value,
      avoidDays: Number($("avoidDays").value),
      numQ: Number($("numQ").value),
      mode: $("mode").value,
      cat: $("cat").value || "",
      savedAt: todayKey(),
    };
    localStorage.setItem(SETTINGS_KEY, JSON.stringify(s));
  }

  function loadCatOverride(){
    try{ return JSON.parse(localStorage.getItem(CAT_OVERRIDE_KEY) || "{}"); }
    catch{ return {}; }
  }

  async function loadCats(){
    try{
      const res = await fetch("./words.json", {cache:"no-store"});
      const words = await res.json();
      const ov = loadCatOverride();
      const set = new Set();

      for (const w of (words||[])){
        if (!w || !w.id) continue;
        const c = norm(ov[w.id] ?? w.cat ?? "");
        if (c) set.add(c);
      }
      const cats = Array.from(set).sort((a,b)=>a.localeCompare(b,"zh-Hant"));
      $("cat").innerHTML = `<option value="">全部分類</option>` + cats.map(c=>`<option value="${c}">${c}</option>`).join("");
    }catch{
      $("cat").innerHTML = `<option value="">全部分類</option>`;
    }
  }

  $("btnGo").addEventListener("click", () => {
    saveSettings();
    location.href = "./index.html";
  });

  loadCats().then(loadSettings);
</script>
</body>
</html>
